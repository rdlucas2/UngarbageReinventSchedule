<!DOCTYPE html>
<html>

<head>
    <title>
        Ungarbage Event Calendar
    </title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.3/main.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var overflowEl = document.getElementById('overflow');
            var refreshEl = document.getElementById("refresh");
            var calendar = null;
            var currentDate = new Date();
            var vegasOffset = getTimeZoneOffset(currentDate, 'America/Los_Angeles');
            var localOffset = getTimeZoneOffset(currentDate, Intl.DateTimeFormat().resolvedOptions().timeZone);
            var offsetFromLosAngelesTime = (vegasOffset - (((vegasOffset - localOffset) / 60) > 12 ? localOffset - 60 : localOffset)) * 60 * 1000; //for New York, should be = 10800000
            var resources = [];
            var apiBaseUrl = 'http://localhost:8000/api';

            var stringToColor = (string, saturation = 100, lightness = 75) => {
                let hash = 0;
                for (let i = 0; i < string.length; i++) {
                    hash = string.charCodeAt(i) + ((hash << 5) - hash);
                    hash = hash & hash;
                }
                return `hsl(${(hash % 360)}, ${saturation}%, ${lightness}%)`;
            }

            function getTimeZoneOffset(date, timeZone) {
                let iso = date.toLocaleString('en-CA', { timeZone, hour12: false }).replace(', ', 'T');
                iso += '.' + date.getMilliseconds().toString().padStart(3, '0');
                const lie = new Date(iso + 'Z');
                return -(lie - date) / 60 / 1000;
            }

            function clearElement(element) {
                while (element.firstChild) {
                    element.removeChild(element.firstChild);
                }
            }

            function displayCalendar(resources, events) {
                clearElement(calendarEl);
                calendar = new FullCalendar.Calendar(calendarEl, {
                    schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
                    themeStyle: 'bootsrap5',
                    initialView: 'resourceTimeline',
                    initialDate: '2022-11-28', //Date.now(),
                    resources: resources,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay,resourceTimeline,resourceTimeGridDay'
                    },
                    events: events
                });
                calendar.render();
            }

            async function getResources(refresh) {
                if (!refresh)
                    refresh = false;
                let response = await fetch(`${apiBaseUrl}/resources?refresh=${refresh}`);
                let rawResources = await response.json();
                let resources = []
                for (let i = 0; i < rawResources.length; i++) {
                    resource = {
                        id: rawResources[i],
                        title: rawResources[i]
                    };
                    resources.push(resource);
                }
                return resources;
            }

            async function getEvents(filter, refresh) {
                if (!refresh)
                    refresh = false;
                let url = `${apiBaseUrl}/events?refresh=${refresh}`
                if (filter) {
                    url = `${apiBaseUrl}/events/${filter}?refresh=${refresh}`
                }
                let response = await fetch(url);
                let rawEvents = await response.json();
                let d = rawEvents.data;
                let events = []
                for (let i = 0; i < d.length; i++) {
                    resourceId = null;
                    let isOverflow = false;
                    if (d[i].venue && d[i].room) {
                        resourceId = `${d[i].venue.name} ${d[i].room.name}`;
                    } else {
                        isOverflow = true;
                    }
                    if (d[i].startTime && d[i].endTime) {
                        //This is a very hacky way to do this, but I didn't want to use npm and webpack or some other build system for the frontend
                        let isConferenceTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone !== 'America/Los_Angeles'
                        event = {
                            id: d[i].eventId,
                            start: isConferenceTimezone ? d[i].startTime - offsetFromLosAngelesTime : d[i].startTime,
                            end: isConferenceTimezone ? d[i].endTime - offsetFromLosAngelesTime : d[i].endTime,
                            title: d[i].name,
                            resourceId: resourceId,
                            backgroundColor: stringToColor(d[i].sessionType.name),
                            textColor: '#000000',
                            borderColor: '#000000'
                        };
                        events.push(event);
                    } else {
                        isOverflow = true;
                    }
                    if (isOverflow) {
                        var li = document.createElement('li');
                        var pre = document.createElement('pre');
                        pre.appendChild(document.createTextNode(JSON.stringify(d[i], null, 4)));
                        li.appendChild(pre);
                        overflowEl.appendChild(li);
                    }
                }
                return events;
            }

            function load_calendar(filter, refresh) {
                clearElement(overflowEl);
                getResources(refresh).then(resources => {
                    getEvents(filter, refresh).then(events => {
                        console.log(events.length);
                        displayCalendar(resources, events);
                    });
                });
            }

            document.getElementById('filter').addEventListener('change', function () {
                console.log('You selected: ', this.value);
                console.log("refresh", refreshEl.checked);
                load_calendar(this.value, refreshEl.checked);
            });

            document.getElementById('overflowToggle').addEventListener('click', function () {
                if (overflowEl.style.display === "none") {
                    overflowEl.style.display = "block";
                } else {
                    overflowEl.style.display = "none";
                }
            });

            load_calendar();
        });
    </script>
</head>

<body>
    <label for="filter">Filter events:</label>
    <select id="filter" name="filter">
        <option value="">all</option>
        <option value="reserved">reserved</option>
        <option value="reservable">reservable</option>
        <option value="favorites">favorites</option>
        <option value="waitlistable">wait list available</option>
    </select>
    <!--
        Should I allow a user to enter their bearer token, and pass it into the request, 
        generalizing this so you don't have to run your own server? 
        Instead of saving to a file, cache events in local storage instead?
    -->
    <!-- <label for="token">Bearer Token for AWS Lambda:</label>
    <input type="password" name="token" id="token" > -->
    <br />
    <input type="checkbox" name="refresh" id="refresh">
    <label for="refresh">Refresh from AWS <br />(only check if you've made changes on the events page or need to receive
        updates)</label>
    <div id="calendar"></div>
    <button id="overflowToggle">Show/Hide Events Without Venue or Times</button>
    <ul id="overflow" style="display:none;"></ul>
</body>

</html>